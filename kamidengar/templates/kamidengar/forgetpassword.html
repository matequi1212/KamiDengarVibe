<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    {% load static %}
</head>
<body class="h-screen flex flex-col bg-[#F1FFE7]">

<!-- SVG background -->
<div class="absolute inset-0 -z-10 overflow-hidden">
    <svg class="w-full h-full" viewBox="0 0 375 812" fill="none" preserveAspectRatio="none">
        <defs>
            <linearGradient id="bg-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#EBFBE4" />
                <stop offset="100%" stop-color="#F1FFE7" />
            </linearGradient>
            <linearGradient id="wave-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="25%" stop-color="#B4DDD4" />
                <stop offset="50%" stop-color="#E4C96E" />
                <stop offset="75%" stop-color="#DDB5B5" />
                <stop offset="100%" stop-color="#AFD7CE" />
            </linearGradient>
        </defs>
        <rect width="100%" height="100%" fill="url(#bg-gradient)" />
        <path d="M0,100 C75,50 300,150 375,100 L375,0 L0,0 Z" 
            fill="url(#wave-gradient)"
            fill-opacity="0.7"
            vector-effect="non-scaling-stroke"/>
        <path d="M0,600 C100,650 275,550 475,600 L375,812 L0,812 Z" 
            fill="url(#wave-gradient)"
            fill-opacity="0.7"
            vector-effect="non-scaling-stroke"/>
    </svg>
</div>

<!-- Back button -->
<div class="absolute top-6 left-6">
    <button onclick="window.history.back()" class="flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back
    </button>
</div>

<!-- App Logo -->
<div class="mt-16 mb-6 flex justify-center">
    <img src="/static/kamidengar/logo.png" alt="App Logo" class="w-48 h-auto mx-auto">
</div>

<!-- Main Content - Email Request Stage -->
<div id="emailStage" class="flex-grow flex flex-col items-center justify-start px-4">
    <h1 class="text-[30px] font-bold font-inter mb-6" style="font-family: 'Inter', sans-serif">Forgot Password</h1>
    
    <form id="emailForm" class="flex flex-col items-center w-full max-w-xs">
        <p class="text-gray-600 mb-4 text-center">Enter your email to receive a password reset link</p>
        
        <!-- Email Field -->
        <div class="flex flex-col mb-6 w-full">
            <label for="forgotEmail" class="text-black mb-1">Email:</label>
            <div class="bg-[#D9D9D9] w-full h-10 p-6 rounded-lg shadow-lg flex items-center">
                <input type="email" id="forgotEmail" class="w-full bg-transparent text-gray-800 border-none focus:outline-none placeholder-gray-600" placeholder="YourEmail@example.com" required>
            </div>
        </div>

        <!-- Status Message -->
        <div id="emailMessage" class="mb-4 text-center w-full"></div>

        <!-- Submit Button -->
        <button type="submit" class="bg-[#D9D9D9] w-full py-3 rounded-full shadow-lg hover:bg-gray-300 transition duration-300 font-medium text-gray-800">
            Send Reset Link
        </button>
    </form>
</div>

<!-- Password Reset Stage (Initially Hidden) -->
<div id="passwordStage" class="hidden flex-grow flex flex-col items-center justify-start px-4">
    <h1 class="text-[30px] font-bold font-inter mb-6" style="font-family: 'Inter', sans-serif">Reset Password</h1>
    
    <form id="passwordForm" class="flex flex-col items-center w-full max-w-xs">
        <!-- New Password Field -->
        <div class="flex flex-col mb-4 w-full">
            <label for="resetPassword" class="text-black mb-1">New Password:</label>
            <div class="bg-[#D9D9D9] w-full h-10 p-6 rounded-lg shadow-lg flex items-center">
                <input type="password" id="resetPassword" class="w-full bg-transparent text-gray-800 border-none focus:outline-none placeholder-gray-600" placeholder="********" required minlength="6">
            </div>
        </div>

        <!-- Confirm Password Field -->
        <div class="flex flex-col mb-6 w-full">
            <label for="confirmResetPassword" class="text-black mb-1">Confirm Password:</label>
            <div class="bg-[#D9D9D9] w-full h-10 p-6 rounded-lg shadow-lg flex items-center">
                <input type="password" id="confirmResetPassword" class="w-full bg-transparent text-gray-800 border-none focus:outline-none placeholder-gray-600" placeholder="********" required minlength="6">
            </div>
        </div>

        <!-- Status Message -->
        <div id="passwordMessage" class="mb-4 text-center w-full"></div>

        <!-- Submit Button -->
        <button type="submit" class="bg-[#D9D9D9] w-full py-3 rounded-full shadow-lg hover:bg-gray-300 transition duration-300 font-medium text-gray-800">
            Update Password
        </button>
    </form>
</div>

<!-- Firebase Initialization and Password Reset Logic -->
<script>
    // Your Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDxUojvQOowLYJAUdd-PRArjiR2TlxeV78",
        authDomain: "kamidengar-36c83.firebaseapp.com",
        projectId: "kamidengar-36c83",
        storageBucket: "kamidengar-36c83.firebasestorage.app",
        messagingSenderId: "310947680381",
        appId: "1:310947680381:web:af6a0a2f79759d94d1a114",
        measurementId: "G-XR8Y9NB893"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Check if we're coming back from a password reset link
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    const actionCode = urlParams.get('oobCode');
    
    if (mode === 'resetPassword' && actionCode) {
        // Show password reset form
        document.getElementById('emailStage').classList.add('hidden');
        document.getElementById('passwordStage').classList.remove('hidden');
        
        // Handle password reset
        document.getElementById('passwordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newPassword = document.getElementById('resetPassword').value;
            const confirmPassword = document.getElementById('confirmResetPassword').value;
            const messageEl = document.getElementById('passwordMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Clear previous messages
            messageEl.textContent = '';
            messageEl.className = 'mb-4 text-center';
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                messageEl.textContent = "Passwords do not match!";
                messageEl.className += ' text-red-600';
                return;
            }
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
            
            // Confirm the password reset code and update password
            auth.confirmPasswordReset(actionCode, newPassword)
                .then(() => {
                    // Password updated successfully
                    messageEl.textContent = "Password updated successfully! Redirecting to login...";
                    messageEl.className += ' text-green-600';
                    
                    // Redirect to login after 2 seconds
                    setTimeout(() => {
                        window.location.href = '/loginpage/';
                    }, 2000);
                })
                .catch((error) => {
                    // Handle errors
                    let errorMessage = "Password reset failed. The link may have expired.";
                    
                    if (error.code === 'auth/weak-password') {
                        errorMessage = "Password should be at least 6 characters.";
                    }
                    
                    messageEl.textContent = errorMessage;
                    messageEl.className += ' text-red-600';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Update Password';
                });
        });
    } else {
        // Handle email submission for password reset
        document.getElementById('emailForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const email = document.getElementById('forgotEmail').value;
            const messageEl = document.getElementById('emailMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Clear previous messages
            messageEl.textContent = '';
            messageEl.className = 'mb-4 text-center';
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';
            
            // Send password reset email
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    // Email sent successfully
                    messageEl.textContent = "Password reset email sent! Check your inbox.";
                    messageEl.className += ' text-green-600';
                    submitBtn.textContent = 'Email Sent';
                    
                    // Optionally redirect after delay
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 3000);
                })
                .catch((error) => {
                    // Handle errors
                    let errorMessage = "Error sending reset email. Please try again.";
                    
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = "No account found with this email.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Please enter a valid email address.";
                    }
                    
                    messageEl.textContent = errorMessage;
                    messageEl.className += ' text-red-600';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Send Reset Link';
                });
        });
    }
</script>
</body>
</html>